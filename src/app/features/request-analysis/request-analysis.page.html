<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Request Custom Analysis</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="viewHistory()">
        <ion-icon slot="icon-only" name="time-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="request-container">
    
    <!-- Header Section -->
    <div class="header-section">
      <ion-icon name="analytics-outline" class="main-icon"></ion-icon>
      <h1>Custom Research Request</h1>
      <p class="subtitle">Get AI-powered analysis for any ticker</p>
    </div>
    
    <!-- Quota Display -->
    <ion-card *ngIf="quotaStatus" class="quota-card">
      <ion-card-content>
        <div class="quota-display">
          <div class="quota-info">
            <div class="quota-count">
              <span class="remaining">{{ quotaStatus.quotaRemaining }}</span>
              <span class="total">/{{ quotaStatus.quotaLimit }}</span>
            </div>
            <p class="quota-label">Reports Remaining</p>
          </div>
          
          <div class="plan-badge" [class.premium]="quotaStatus.plan === 'premium'">
            <ion-icon [name]="quotaStatus.plan === 'premium' ? 'star' : 'person-outline'"></ion-icon>
            {{ quotaStatus.plan === 'premium' ? 'Premium' : 'Free' }}
          </div>
        </div>
        
        <ion-note *ngIf="quotaStatus.resetDate" class="reset-date">
          Resets on {{ quotaStatus.resetDate | date:'mediumDate' }}
        </ion-note>
      </ion-card-content>
    </ion-card>
    
    <!-- No Quota Warning -->
    <ion-card *ngIf="quotaStatus && quotaStatus.quotaRemaining === 0" color="warning" class="warning-card">
      <ion-card-content>
        <div class="warning-content">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <div>
            <h3>No Reports Remaining</h3>
            <p>Upgrade to Premium for {{ quotaStatus.plan === 'free' ? '10' : '20' }} monthly reports!</p>
          </div>
        </div>
        <ion-button expand="block" color="light" (click)="showUpgradePrompt()">
          Upgrade Now
        </ion-button>
      </ion-card-content>
    </ion-card>
    
    <!-- Request Form -->
    <ion-card class="request-form-card">
      <ion-card-content>
        <form (ngSubmit)="submitRequest()">
          
          <!-- Asset Type Selector -->
          <div class="asset-type-selector">
            <ion-segment [(ngModel)]="assetType" name="assetType" [disabled]="loading">
              <ion-segment-button value="stock">
                <ion-label>Stock</ion-label>
                <ion-icon name="trending-up-outline"></ion-icon>
              </ion-segment-button>
              <ion-segment-button value="crypto">
                <ion-label>Crypto</ion-label>
                <ion-icon name="logo-bitcoin"></ion-icon>
              </ion-segment-button>
            </ion-segment>
          </div>
          
          <!-- Ticker Search with Autocomplete -->
          <div class="search-container">
            <ion-item lines="none" class="search-input">
              <ion-label position="stacked">
                Search Ticker
                <ion-text color="danger">*</ion-text>
              </ion-label>
              <ion-searchbar
                [(ngModel)]="searchQuery"
                name="searchQuery"
                placeholder="Search stocks or crypto (e.g., Apple, Bitcoin)"
                (ionInput)="onSearchInput($event)"
                (ionFocus)="onSearchFocus()"
                (ionBlur)="onSearchBlur()"
                (ionClear)="clearSearch()"
                [disabled]="loading"
                debounce="0"
                showClearButton="always"
              ></ion-searchbar>
            </ion-item>
            
            <!-- Search Results Dropdown -->
            <div class="search-results" *ngIf="showSearchResults">
              <!-- Loading State -->
              <div class="search-loading" *ngIf="searchLoading">
                <ion-spinner name="crescent"></ion-spinner>
                <p>Searching...</p>
              </div>
              
              <!-- Results List -->
              <div class="results-list" *ngIf="!searchLoading && searchResults.length > 0">
                <div 
                  class="result-item" 
                  *ngFor="let result of searchResults"
                  (click)="selectResult(result)"
                >
                  <div class="result-logo">
                    <img *ngIf="result.logo" [src]="result.logo" [alt]="result.symbol" />
                    <ion-icon 
                      *ngIf="!result.logo" 
                      [name]="result.type === 'crypto' ? 'logo-bitcoin' : 'trending-up-outline'"
                    ></ion-icon>
                  </div>
                  
                  <div class="result-info">
                    <div class="result-main">
                      <span class="result-symbol">{{ result.symbol }}</span>
                      <span class="result-name">{{ result.name }}</span>
                    </div>
                    <div class="result-meta">
                      <ion-badge [color]="result.type === 'crypto' ? 'warning' : 'primary'">
                        {{ result.type === 'crypto' ? 'Crypto' : 'Stock' }}
                      </ion-badge>
                      <span *ngIf="result.price" class="result-price">
                        ${{ result.price | number:'1.2-2' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Empty State -->
              <div class="search-empty" *ngIf="!searchLoading && searchResults.length === 0">
                <ion-icon name="search-outline"></ion-icon>
                <p>No results found</p>
                <small>Try searching for another ticker</small>
              </div>
            </div>
          </div>
          
          <!-- Selected Ticker Display -->
          <div class="selected-ticker" *ngIf="ticker">
            <ion-chip color="primary" outline="true">
              <ion-icon name="checkmark-circle"></ion-icon>
              <ion-label>{{ ticker }} - {{ assetType === 'crypto' ? 'Crypto' : 'Stock' }}</ion-label>
            </ion-chip>
          </div>
          
          <!-- Validation Error -->
          <ion-note *ngIf="getValidationError()" color="danger" class="validation-error">
            {{ getValidationError() }}
          </ion-note>
          
          <!-- Info Box -->
          <div class="info-box">
            <ion-icon name="information-circle-outline"></ion-icon>
            <div>
              <p><strong>What you'll get:</strong></p>
              <ul>
                <li>Multi-timeframe technical analysis</li>
                <li>News sentiment & fundamental analysis</li>
                <li>AI-powered trading verdict</li>
                <li>Entry, stop, and target recommendations</li>
              </ul>
              <p class="processing-time">
                <ion-icon name="time-outline"></ion-icon>
                Processing takes 2-5 minutes
              </p>
            </div>
          </div>
          
          <!-- Submit Button -->
          <ion-button
            expand="block"
            type="submit"
            [disabled]="!isFormValid() || loading"
            class="submit-button"
          >
            <ion-icon slot="start" name="rocket-outline"></ion-icon>
            {{ loading ? 'Submitting...' : 'Request Analysis' }}
          </ion-button>
          
        </form>
      </ion-card-content>
    </ion-card>
    
    <!-- Success Message -->
    <ion-card *ngIf="submitted" color="success" class="success-card">
      <ion-card-content>
        <div class="success-content">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <div>
            <h3>Request Submitted! ðŸŽ‰</h3>
            <p>We'll notify you when your {{ ticker }} analysis is ready.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
    
    <!-- How It Works -->
    <div class="how-it-works">
      <h2>How It Works</h2>
      
      <div class="steps">
        <div class="step">
          <div class="step-number">1</div>
          <div class="step-content">
            <h3>Search Ticker</h3>
            <p>Search for any stock or crypto asset</p>
          </div>
        </div>
        
        <div class="step">
          <div class="step-number">2</div>
          <div class="step-content">
            <h3>AI Analysis</h3>
            <p>Our agents research and analyze in real-time</p>
          </div>
        </div>
        
        <div class="step">
          <div class="step-number">3</div>
          <div class="step-content">
            <h3>Get Notified</h3>
            <p>Receive push notification when ready</p>
          </div>
        </div>
        
        <div class="step">
          <div class="step-number">4</div>
          <div class="step-content">
            <h3>Read & Trade</h3>
            <p>View insights and make informed decisions</p>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</ion-content>
